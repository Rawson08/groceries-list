<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Groceries List Manager</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      const MY_APPS_URL = "https://roshansubedi.me/my-apps";
      const GLM_BACKEND_URL =
        "https://groceries-list-backend-27e12ecc8182.herokuapp.com";
      const AUTH_BACKEND_URL =
        "https://my-apps-backend-e1163c7dec9d.herokuapp.com";

      // Helper function to get token from URL
      function getTokenFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("token");
      }

      // Redirect to My Apps on error
      function redirectToMyApps(message) {
        // alert(message);
        window.location.href = MY_APPS_URL;
      }

      // Fetch and greet user
      async function getUserInfo() {
        const token = getTokenFromUrl();
        try {
          const response = await fetch(`${AUTH_BACKEND_URL}/auth/user-info`, {
            method: "GET",
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const data = await response.json();
            greetUser(data.firstname);
          } else {
            redirectToMyApps("Session expired. Please log in again.");
          }
        } catch {
          redirectToMyApps("An error occurred. Redirecting to login.");
        }
      }

      // Greet user with their name
      function greetUser(firstname) {
        const mainTitle = document.getElementById("main-title");
        mainTitle.textContent = `Welcome to Groceries List Manager, ${firstname}`;
      }

      // Fetch and load user's grocery list
      async function loadList() {
        const token = getTokenFromUrl();
        const userId = decodeToken(token).id;

        try {
          const response = await fetch(
            `${GLM_BACKEND_URL}/get-list/${userId}`,
            {
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (response.ok) {
            const listData = await response.json();
            renderList(listData.items || []);
          } else {
            alert("Error fetching your list.");
          }
        } catch {
          alert("An error occurred while loading your list.");
        }
      }

      // Render the grocery list
      function renderList(items) {
        const ownList = document.getElementById("ownList");
        ownList.innerHTML = ""; // Clear existing items
        items.forEach((item) => {
          const li = document.createElement("li");
          const id = `item-${Math.random().toString(36).substr(2, 9)}`;
          li.innerHTML = `
            <input type="checkbox" id="${id}" value="${item}">
            <label for="${id}">${capitalize(item)}</label> 
            <button onclick="removeFromOwnList('${item}')">Remove</button>
          `;
          ownList.appendChild(li);
        });
      }

      // Add a new item to the list
      async function addToOwnList() {
        const newItemInput = document.getElementById("newItemInput");
        const newItem = newItemInput.value.trim();
        if (!newItem) {
          alert("Item cannot be empty!");
          return;
        }

        const token = getTokenFromUrl();
        const userId = decodeToken(token).id;

        try {
          const response = await fetch(`${GLM_BACKEND_URL}/save-list`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ userId, items: [newItem] }),
          });

          if (response.ok) {
            loadList();
            newItemInput.value = ""; // Clear input field
          } else {
            alert("Error adding item to the list.");
          }
        } catch {
          alert("An error occurred while adding the item.");
        }
      }

      // Remove an item from the list
      async function removeFromOwnList(item) {
        const token = getTokenFromUrl();
        const userId = decodeToken(token).id;

        try {
          const response = await fetch(`${GLM_BACKEND_URL}/remove-item`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ userId, item }),
          });

          if (response.ok) {
            loadList();
          } else {
            alert("Error removing the item.");
          }
        } catch {
          alert("An error occurred while removing the item.");
        }
      }

      // Decode JWT token
      function decodeToken(token) {
        const base64Url = token.split(".")[1];
        return JSON.parse(atob(base64Url));
      }

      // Capitalize the first letter of a string
      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      // Handle logout
      function handleLogout() {
        redirectToMyApps("You have been logged out.");
      }

      // Initialize the app
      window.onload = async function () {
        const token = getTokenFromUrl();
        if (!token) redirectToMyApps("You must log in to access this page.");

        await getUserInfo();
        await loadList();

        // Save list before page unload
        window.addEventListener("beforeunload", saveList);
      };

      // Save the grocery list
      async function saveList() {
        const items = Array.from(document.querySelectorAll("#ownList li")).map(
          (li) => li.textContent.split("Remove")[0].trim()
        );

        const token = getTokenFromUrl();
        const userId = decodeToken(token).id;

        try {
          await fetch(`${GLM_BACKEND_URL}/save-list`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ userId, items }),
          });
        } catch {
          console.error("Failed to save the list.");
        }
      }
    </script>
  </head>
  <body>
    <h1 id="main-title">Welcome to the Groceries List Manager</h1>
    <button onclick="handleLogout()">Go back to app list</button>

    <div>
      <h2>Create Your Own List</h2>
      <input
        type="text"
        id="newItemInput"
        placeholder="Enter a grocery item"
        maxlength="20"
      />
      <button onclick="addToOwnList()">Add to My List</button>
      <ul id="ownList"></ul>
    </div>
  </body>
</html>
