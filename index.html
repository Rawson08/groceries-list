<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Groceries List Manager</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      const MY_APPS_URL = "https://roshansubedi.me/my-apps";

      function getTokenFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("token");
      }

      async function initializeApp() {
        const token = getTokenFromUrl();

        if (!token) {
          redirectToMyApps("Token not found. Redirecting to login.");
          return;
        }
        console.log("Token:", token);

        try {
          const response = await fetch(
            "https://my-apps-backend-e1163c7dec9d.herokuapp.com/auth/user-info",
            {
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          console.log("Response Status:", response.status); // Debugging

          if (response.ok) {
            const data = await response.json();
            console.log("User Info:", data); // Debugging

            greetUser(data.firstname);
            loadList(); // Load the grocery list
          } else {
            console.error("Unexpected error:", response.statusText);

            redirectToMyApps("Session expired. Please log in again.");
          }
        } catch (error) {
          console.error("Error verifying token:", error);
          redirectToMyApps("An error occurred. Redirecting to login.");
        }
      }

      function redirectToMyApps(message) {
        alert(message);
        localStorage.removeItem("token");
        window.location.href = MY_APPS_URL;
      }

      function greetUser(firstName) {
        const greeting = document.getElementById("greeting");
        greeting.textContent = `Welcome, ${capitalizeFirstLetter(firstName)}!`;
      }

      function capitalizeFirstLetter(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      async function loadList() {
        const token = localStorage.getItem("token");

        try {
          const response = await fetch(
            `https://groceries-list-backend-27e12ecc8182.herokuapp.com/get-list/${userId}`,
            {
              method: "GET",
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (response.ok) {
            const data = await response.json();
            const list = document.getElementById("grocery-list");
            list.innerHTML = ""; // Clear existing items

            data.items.forEach((item) => {
              const li = document.createElement("li");
              li.textContent = capitalizeFirstLetter(item);

              const removeButton = document.createElement("button");
              removeButton.textContent = "Remove";
              removeButton.onclick = () => removeItem(item, li);

              li.appendChild(removeButton);
              list.appendChild(li);
            });
          } else {
            console.error("Error loading list:", response.statusText);
          }
        } catch (error) {
          console.error("Error fetching list:", error);
        }
      }

      async function addItem() {
        const newItemInput = document.getElementById("new-item");
        const newItem = newItemInput.value.trim();

        if (!newItem) {
          alert("Please enter a valid item.");
          return;
        }

        const token = localStorage.getItem("token");

        try {
          const response = await fetch(
            "https://groceries-list-backend-27e12ecc8182.herokuapp.com/save-list",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ items: [newItem] }),
            }
          );

          if (response.ok) {
            loadList(); // Refresh the list
            newItemInput.value = ""; // Clear the input
          } else {
            alert("Error adding item.");
          }
        } catch (error) {
          console.error("Error adding item:", error);
        }
      }

      async function removeItem(item, listItemElement) {
        const token = localStorage.getItem("token");

        try {
          const response = await fetch(
            "https://groceries-list-backend-27e12ecc8182.herokuapp.com/remove-item",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ item }),
            }
          );

          if (response.ok) {
            listItemElement.remove(); // Remove item from the DOM
          } else {
            alert("Error removing item.");
          }
        } catch (error) {
          console.error("Error removing item:", error);
        }
      }

      function handleLogout() {
        localStorage.removeItem("token");
        redirectToMyApps("You have been logged out.");
      }

      window.onload = initializeApp;
    </script>
  </head>
  <body>
    <header>
      <h1 id="greeting">Welcome!</h1>
      <button onclick="handleLogout()">Back to app list</button>
    </header>

    <main>
      <section id="add-item-section">
        <h2>Add a New Item</h2>
        <input type="text" id="new-item" placeholder="Enter a grocery item" />
        <button onclick="addItem()">Add Item</button>
      </section>

      <section id="grocery-list-section">
        <h2>Your Grocery List</h2>
        <ul id="grocery-list"></ul>
      </section>
    </main>
  </body>
</html>
